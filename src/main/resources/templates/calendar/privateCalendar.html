<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity6"
      layout:decorate="~{page_layout/layout}">
<head>
  <meta charset="UTF-8">
  <title>Calendar</title>
</head>
<body>
<div layout:fragment="main-content">
    <link rel="stylesheet" href="/css/event-calendar.min.css">
    
    <style>
        /* Το κουμπι today θελει ειδικο styling για να μην δειχνει χαλια */
        #ec .ec-button.ec-today {
            background-color: #495057;
            color: white !important;
            border-color: #495057;
        }
        
        /* μεγεθος κειμενου των events */
        #ec .ec-event-title,
        #ec .ec-event-time,
        #ec .fc-event-title,
        #ec .fc-event-time {
            font-size: 11px !important;
            line-height: 1.2 !important;
        }
        
        #ec .fc-event, #ec .ec-event {
            cursor: pointer;
        }
        
		#ec .ec-event,
		#ec .fc-event {
		    border: 1px solid rgba(255, 255, 255, 0.4);
		    box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.25);
		    box-sizing: border-box;
		}

    </style>
    
    <div style="text-align: left; max-width: 1200px; margin: 0 auto; min-height: 800px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
		    <h2 style="color: white; margin: 0;">Event Calendar</h2>
		
		    <a sec:authorize="hasRole('ROLE_TRAINER')"
		       href="/availabilities/create"
		       style="
		           background-color: #28a745;
		           color: white;
		           padding: 8px 14px;
		           border-radius: 5px;
		           text-decoration: none;
		           font-weight: bold;
		       ">
		        + Add New Availability
		    </a>
		</div>

        <div style="display: flex; gap: 16px; align-items: flex-start;">

    <!-- Calendar -->
    <div id="ec"
         style="
            flex: 1;
            min-width: 600px;
            height: 700px;
            background: #474646;
            padding: 15px;
            border-radius: 8px;
         ">
    </div>

    <!-- Legend -->
    <div style="
        width: 200px;
        background: #3f3f3f;
        padding: 12px 14px;
        border-radius: 8px;
        color: white;
        font-size: 13px;
        flex-shrink: 0;
    ">
        <div style="font-weight: bold; margin-bottom: 8px;">Legend</div>

        <div style="display: flex; align-items: center; margin-bottom: 6px;">
            <span style="width:14px;height:14px;background:#4FBF36;border-radius:3px;margin-right:8px;"></span>
            Availability
        </div>

        <hr style="border-color:#555;margin:8px 0;">

        <div style="display: flex; align-items: center; margin-bottom: 6px;">
            <span style="width:14px;height:14px;background:#A3A5FF;border-radius:3px;margin-right:8px;"></span>
            Requested Appointment
        </div>

        <div style="display: flex; align-items: center; margin-bottom: 6px;">
            <span style="width:14px;height:14px;background:#0600FF;border-radius:3px;margin-right:8px;"></span>
            Accepted Appointment
        </div>
        
        <div style="display: flex; align-items: center; margin-bottom: 6px;">
            <span style="width:14px;height:14px;background:#040050;border-radius:3px;margin-right:8px;"></span>
            Completed Appointment
        </div>

        <div style="display: flex; align-items: center; margin-bottom: 6px;">
            <span style="width:14px;height:14px;background:#737373;border-radius:3px;margin-right:8px;"></span>
            Rejected Appointment
        </div>

        <div style="display: flex; align-items: center;">
            <span style="width:14px;height:14px;background:#FF0000;border-radius:3px;margin-right:8px;"></span>
            Canceled Appointment
        </div>
    </div>

</div>

    </div>
    
    <script src="/js/event-calendar.min.js"></script>
    <script th:inline="javascript">
        setTimeout(function() {
        	var backendEvents = /*[[${eventList}]]*/ [];
        	//window.__backendEvents = backendEvents;
            
            // μετατροπη σε μορφη ημερολογιου
            var calendarEvents = backendEvents.map(function(event) {
                var title = event.type === 'appointment' ? 'Appointment' : 
                           event.type === 'availability_onetime' ? 'Available (One-time)' :
                           event.type === 'availability_recurring' ? 'Available (Recurring)' : 'Available';
                
                return {
                    id: event.id,
                    title: title,
                    start: event.start,
                    end: event.end,
                    backgroundColor: event.color,
                    extendedProps: {
                        fullTitle: title,
                        type: event.type
                    }
                };
            });
            
            let ec = EventCalendar.create(document.getElementById('ec'), {
                view: 'timeGridWeek',
                headerToolbar: {
                    start: 'prev,next today',
                    center: 'title',
                    end: ''
                },
                height: '100%',
                editable: false,
                selectable: false,
                eventStartEditable: false,
                eventDurationEditable: false,
                droppable: false,
                eventOverlap: true,
                slotEventOverlap: true,
                eventMaxStack: 5,
                // παιρνουμε τα events απο το backend
                events: calendarEvents,
                eventClick: function(info) {
				    let eid = info.event.id;
				    let eventType = info.event.extendedProps.type;
				    
				    if (!eid || !eventType) return;
				    
				    // διαφορετικη συμπεριφορα αναλογα με τον τυπο event
				    if (eventType === 'appointment') {
				        window.location.href = '/appointments/' + encodeURIComponent(eid) + '/view';
				    } else if (eventType === 'availability_onetime' || eventType === 'availability_recurring') {
				        window.location.href = '/availabilities/' + encodeURIComponent(eid) + '/view';
				    }
				},
                eventDidMount: function(info) {
                    info.el.setAttribute('title', info.event.title);
                }
            });
        }, 100);
    </script>
</div>
</body>
</html>